# =============================================================================
# FILE: configuration.yaml
# VERSION: 2026.02.13.5
# DESCRIPTION: Core Config with PSE-Integrated Cost Logic & MQTT
# =============================================================================

default_config:

frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# -----------------------------------------------------------------------------
# MQTT INFRASTRUCTURE (Tuya Bridge Meter)
# -----------------------------------------------------------------------------
mqtt:
  sensor:
    - name: "Tuya Bridge Voltage"
      unique_id: "tuya_bridge_voltage"
      state_topic: "tuya/bridge/voltage"
      unit_of_measurement: "V"
      device_class: "voltage"
      state_class: "measurement"
      value_template: "{{ value }}"

    - name: "Tuya Bridge Current"
      unique_id: "tuya_bridge_current"
      state_topic: "tuya/bridge/current"
      unit_of_measurement: "A"
      device_class: "current"
      state_class: "measurement"
      value_template: "{{ value }}"

    - name: "Tuya Bridge Power"
      unique_id: "tuya_bridge_power"
      state_topic: "tuya/bridge/power"
      unit_of_measurement: "W"
      device_class: "power"
      state_class: "measurement"
      # Adding | float(0) ensures the result is always a number (0) even if empty
      value_template: "{{ value | float(0) }}"
# -----------------------------------------------------------------------------
# SOURCE-CONTROLLED INPUTS (Rates & Toggles)
# -----------------------------------------------------------------------------
input_number:
  pse_fallback_electric_rate:
    name: "PSE Fallback Electric Rate"
    min: 0.08
    max: 0.30
    step: 0.01
    unit_of_measurement: "$/kWh"
    initial: 0.12 # PSE Tier 1 baseline
  
  pse_fallback_gas_rate:
    name: "PSE Fallback Gas Rate"
    min: 0.80
    max: 2.50
    step: 0.10
    unit_of_measurement: "$/therm"
    initial: 1.25 # 2026 average rate

# -----------------------------------------------------------------------------
# COST DECISION ENGINE (The "Brain")
# -----------------------------------------------------------------------------
template:
  - sensor:
      - name: "Heating Cost Comparison"
        unique_id: heating_cost_comparison
        state: >
          {# 1. Extract Rates #}
          {% set elec = states('sensor.pse_energy_cost_electric_current_bill_to_date') | float(states('input_number.pse_fallback_electric_rate')|float) %}
          {% set gas = states('sensor.pse_energy_cost_gas_current_bill_to_date') | float(states('input_number.pse_fallback_gas_rate')|float) %}
          {% set outdoor = states('sensor.outdoor_temperature') | float(40) %}
          
          {# 2. Estimate Heat Pump COP #}
          {% if outdoor > 47 %} {% set cop = 3.8 %}
          {% elif outdoor > 32 %} {% set cop = 2.8 %}
          {% else %} {% set cop = 2.1 %} {% endif %}
          
          {# 3. Normalized Cost (per 100k BTU) #}
          {% set cost_hp = (29.3 / cop) * elec %}
          {% set cost_furnace = 1.25 * gas %}
          
          {% if cost_hp < cost_furnace %} heat_pump {% else %} furnace {% endif %}
        attributes:
          recommendation: >
             {{ "Efficient Mini-Split" if (states('sensor.heating_cost_comparison') == 'heat_pump') else "Stable Gas Furnace" }}

lovelace:
  mode: storage
  dashboards:
    hvac-advanced: # This is the URL slug
      mode: yaml
      title: "HVAC AI Monitor"
      icon: mdi:gauge
      show_in_sidebar: true
      filename: dashboards/hvac_monitor.yaml # Path must be relative to /config/
