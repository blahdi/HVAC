# =============================================================================
# FILE: configuration.yaml
# VERSION: 2026.02.14.85
# =============================================================================
default_config:
frontend:
  themes: !include_dir_merge_named themes
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

mqtt:
  sensor:
    - name: "Total HVAC Power"
      unique_id: "tuya_w_final_lock"
      state_topic: "tuya/energy/clamp1_power"
      unit_of_measurement: "W"
      device_class: "power"
      state_class: "measurement"
      value_template: "{{ value | float(0) }}"
    - name: "Heatpump Total Current"
      unique_id: "tuya_a_final_lock"
      state_topic: "tuya/energy/clamp1_current"
      unit_of_measurement: "A"
      device_class: "current"
      state_class: "measurement"
      value_template: "{{ value | float(0) }}"
    - name: "Tuya Bridge Voltage"
      unique_id: "tuya_v_final_lock"
      state_topic: "tuya/energy/voltage"
      unit_of_measurement: "V"
      device_class: "voltage"
      state_class: "measurement"

input_text:
  hvac_last_action_db:
    name: "HVAC Last Action DB"
    max: 255

input_boolean:
  hvac_automation_enabled:
    name: "Furnace Automation Enabled"
  heatpump_automation_enabled:
    name: "Heatpump Automation Enabled"

template:
  - trigger:
      - platform: state
        entity_id: input_text.hvac_last_action_db
      - platform: homeassistant
        event: start
    sensor:
      - name: "HVAC Event Log"
        unique_id: "hvac_event_log_fixed"
        state: "{{ now().strftime('%H:%M') }}"
        attributes:
          table_data: >
            {% set old = state_attr('sensor.hvac_event_log', 'table_data') or "" %}
            {% set raw = states('input_text.hvac_last_action_db') %}
            {% set parts = raw.split(' | ') %}
            {% if parts | length >= 5 %}
              {% set new_line = now().strftime('%H:%M') ~ ' | ' ~ parts[0] ~ ' | ' ~ parts[1] ~ ' | ' ~ parts[2] ~ ' | ' ~ parts[3] ~ ' | ' ~ parts[4] %}
              {% set all_lines = (new_line + '\n' + old).split('\n') %}
              {{ all_lines[:20] | join('\n') }}
            {% else %}
              {{ old }}
            {% endif %}
