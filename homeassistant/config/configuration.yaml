# =============================================================================
# FILE: configuration.yaml
# VERSION: 2026.02.14.47
# =============================================================================

default_config:
frontend:
  themes: !include_dir_merge_named themes
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

mqtt:
  sensor:
    - name: "Total HVAC Power"
      unique_id: "tuya_w_final_lock"
      state_topic: "tuya/energy/clamp1_power"
      unit_of_measurement: "W"
      device_class: "power"
      state_class: "measurement"
      value_template: "{{ value | float(0) }}"
      force_update: true
    - name: "Heatpump Total Current"
      unique_id: "tuya_a_final_lock"
      state_topic: "tuya/energy/clamp1_current"
      unit_of_measurement: "A"
      device_class: "current"
      state_class: "measurement"
      value_template: "{{ value | float(0) }}"
      force_update: true
    - name: "Tuya Bridge Voltage"
      unique_id: "tuya_v_final_lock"
      state_topic: "tuya/energy/voltage"
      unit_of_measurement: "V"
      device_class: "voltage"
      state_class: "measurement"
      force_update: true

input_text:
  hvac_last_action_db:
    name: "HVAC Last Action DB"
    max: 255

input_boolean:
  hvac_automation_enabled:
    name: "Furnace Automation Enabled"

template:
  - trigger:
      - platform: state
        entity_id: input_text.hvac_last_action_db
    sensor:
      - name: "HVAC Story Database"
        unique_id: "hvac_story_db_permanent"
        state: "{{ now().strftime('%H:%M') }}"
        attributes:
          history: >
            {% set current = state_attr('sensor.hvac_story_database', 'history') or [] %}
            {% set raw = states('input_text.hvac_last_action_db') %}
            {% if raw is not none and '|' in raw %}
              {% set p = raw.split('|') %}
              {% set new = [{
                'time': now().strftime('%H:%M'),
                'zone': p[0]|trim,
                'status': p[1]|trim,
                'target': p[2]|trim,
                'mode': p[3]|trim
              }] %}
              {{ (new + current)[:10] }}
            {% else %}
              {{ current }}
            {% endif %}

lovelace:
  mode: storage
  dashboards:
    hvac-advanced:
      mode: yaml
      title: "HVAC AI Monitor"
      filename: dashboards/hvac_monitor.yaml
